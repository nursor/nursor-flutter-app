name: Build Release

on:
  push:
    tags:
      - 'v*'  # 触发所有以 v 开头的 tag，例如 v1.0.0

jobs:
  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods dependencies
        working-directory: macos
        run: pod install

      - name: Build macOS ARM64
        run: |
          TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          flutter build macos --release \
            --dart-define=FLUTTER_BUILD_NAME=$TAG_NAME \
            --dart-define=FLUTTER_BUILD_NUMBER=$(date +%s)
        env:
          ARCHS: arm64
          ONLY_ACTIVE_ARCH: NO

      - name: Create DMG for ARM64
        run: |
          cd build/macos/Build/Products/Release
          APP_NAME=$(find . -name "*.app" -type d | head -n 1 | xargs basename)
          APP_BASE_NAME="${APP_NAME%.app}"
          
          # 创建临时目录
          mkdir -p /tmp/dmg-build-arm64
          cp -R "$APP_NAME" /tmp/dmg-build-arm64/
          
          # 创建 DMG
          hdiutil create -volname "${APP_BASE_NAME}-arm64" \
            -srcfolder /tmp/dmg-build-arm64 \
            -ov -format UDZO \
            "${APP_BASE_NAME}-arm64.dmg"
          
          # 移动到输出目录
          mkdir -p ../../../../../dist
          mv "${APP_BASE_NAME}-arm64.dmg" ../../../../../dist/

      - name: Upload macOS ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nursor-app-macos-arm64
          path: |
            build/macos/Build/Products/Release/*.app
            dist/*.dmg
          retention-days: 30

  build-macos-x86_64:
    name: Build macOS x86_64
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods dependencies
        working-directory: macos
        run: pod install

      - name: Build macOS x86_64
        run: |
          TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          flutter build macos --release \
            --dart-define=FLUTTER_BUILD_NAME=$TAG_NAME \
            --dart-define=FLUTTER_BUILD_NUMBER=$(date +%s)
        env:
          ARCHS: x86_64
          ONLY_ACTIVE_ARCH: NO

      - name: Create DMG for x86_64
        run: |
          cd build/macos/Build/Products/Release
          APP_NAME=$(find . -name "*.app" -type d | head -n 1 | xargs basename)
          APP_BASE_NAME="${APP_NAME%.app}"
          
          # 创建临时目录
          mkdir -p /tmp/dmg-build-x86_64
          cp -R "$APP_NAME" /tmp/dmg-build-x86_64/
          
          # 创建 DMG
          hdiutil create -volname "${APP_BASE_NAME}-x86_64" \
            -srcfolder /tmp/dmg-build-x86_64 \
            -ov -format UDZO \
            "${APP_BASE_NAME}-x86_64.dmg"
          
          # 移动到输出目录
          mkdir -p ../../../../../dist
          mv "${APP_BASE_NAME}-x86_64.dmg" ../../../../../dist/

      - name: Upload macOS x86_64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nursor-app-macos-x86_64
          path: |
            build/macos/Build/Products/Release/*.app
            dist/*.dmg
          retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        shell: pwsh
        run: |
          $tagName = "${{ github.ref }}".Replace("refs/tags/v", "").Replace("refs/tags/", "")
          $buildNumber = [Math]::Floor([decimal](Get-Date -UFormat %s))
          flutter build windows --release `
            --dart-define=FLUTTER_BUILD_NAME=$tagName `
            --dart-define=FLUTTER_BUILD_NUMBER=$buildNumber
        env:
          CMAKE_ARGS: -A x64

      - name: Create Windows ZIP
        shell: pwsh
        run: |
          $tagName = "${{ github.ref }}".Replace("refs/tags/v", "").Replace("refs/tags/", "")
          $appName = "nursor_app"
          $zipName = "$appName-windows-x64-$tagName.zip"
          
          cd build/windows/x64/runner/Release
          Compress-Archive -Path * -DestinationPath ../../../../../../$zipName
          
          # 移动到输出目录
          New-Item -ItemType Directory -Force -Path ../../../../../../dist
          Move-Item -Force ../../../../../../$zipName ../../../../../../dist/

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nursor-app-windows
          path: |
            build/windows/x64/runner/Release/**
            dist/*.zip
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            lsb-release
          
          # Install appindicator library based on Ubuntu version
          # Ubuntu 20.04+ uses ayatana, older versions use legacy appindicator
          UBUNTU_VERSION=$(lsb_release -rs | cut -d. -f1)
          FULL_VERSION=$(lsb_release -rs)
          echo "Detected Ubuntu version: $FULL_VERSION (major: $UBUNTU_VERSION)"
          
          # Try to install the appropriate package based on Ubuntu version
          # For Ubuntu 20.04+, prefer ayatana; for older, prefer legacy
          APPINDICATOR_INSTALLED=false
          
          if [ "$UBUNTU_VERSION" -ge 20 ]; then
            echo "Attempting to install libayatana-appindicator3-dev for Ubuntu $FULL_VERSION"
            if sudo apt-get install -y libayatana-appindicator3-dev; then
              APPINDICATOR_INSTALLED=true
              echo "Successfully installed libayatana-appindicator3-dev"
            else
              echo "Failed to install libayatana-appindicator3-dev, trying libappindicator3-dev"
              # Try legacy version as fallback
              sudo apt-get remove -y libayatana-appindicator3-dev 2>/dev/null || true
              if sudo apt-get install -y libappindicator3-dev; then
                APPINDICATOR_INSTALLED=true
                echo "Successfully installed libappindicator3-dev"
              fi
            fi
          else
            echo "Attempting to install libappindicator3-dev for Ubuntu $FULL_VERSION"
            if sudo apt-get install -y libappindicator3-dev; then
              APPINDICATOR_INSTALLED=true
              echo "Successfully installed libappindicator3-dev"
            else
              echo "Failed to install libappindicator3-dev, trying libayatana-appindicator3-dev"
              # Try ayatana version as fallback
              sudo apt-get remove -y libappindicator3-dev 2>/dev/null || true
              if sudo apt-get install -y libayatana-appindicator3-dev; then
                APPINDICATOR_INSTALLED=true
                echo "Successfully installed libayatana-appindicator3-dev"
              fi
            fi
          fi
          
          if [ "$APPINDICATOR_INSTALLED" = false ]; then
            echo "ERROR: Failed to install any appindicator library"
            echo "This is required for tray_manager plugin"
            exit 1
          fi
          
          echo "Appindicator library installation completed successfully"

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Build Linux
        run: |
          flutter build linux --release \
            --dart-define=FLUTTER_BUILD_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//') \
            --dart-define=FLUTTER_BUILD_NUMBER=$(date +%s)

      - name: Create Linux tarball
        run: |
          TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          APP_NAME="nursor_app"
          TARBALL_NAME="${APP_NAME}-linux-x64-${TAG_NAME}.tar.gz"
          
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../../${TARBALL_NAME} *
          
          # 移动到输出目录
          mkdir -p ../../../../../../dist
          mv ../../../../../../${TARBALL_NAME} ../../../../../../dist/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nursor-app-linux
          path: |
            build/linux/x64/release/bundle/**
            dist/*.tar.gz
          retention-days: 30

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-macos-arm64, build-macos-x86_64, build-windows, build-linux]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.PACKAGING_REPO_TOKEN }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## Release ${{ steps.tag.outputs.tag_name }}

            ### Downloads
            - **macOS ARM64**: DMG and APP bundle
            - **macOS x86_64**: DMG and APP bundle  
            - **Windows x64**: ZIP archive
            - **Linux x64**: TAR.GZ archive

            Built from tag: ${{ github.ref }}
          files: |
            artifacts/nursor-app-macos-arm64/**/*
            artifacts/nursor-app-macos-x86_64/**/*
            artifacts/nursor-app-windows/**/*
            artifacts/nursor-app-linux/**/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false

