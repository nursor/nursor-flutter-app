name: Build Release

on:
  push:
    tags:
      - 'v*'  # 触发所有以 v 开头的 tag，例如 v1.0.0

jobs:
  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods dependencies
        working-directory: macos
        run: pod install

      - name: Build macOS ARM64
        run: |
          TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          flutter build macos --release \
            --dart-define=FLUTTER_BUILD_NAME=$TAG_NAME \
            --dart-define=FLUTTER_BUILD_NUMBER=$(date +%s)
        env:
          ARCHS: arm64
          ONLY_ACTIVE_ARCH: NO

      - name: Create DMG for ARM64
        run: |
          cd build/macos/Build/Products/Release
          APP_NAME=$(find . -name "*.app" -type d | head -n 1 | xargs basename)
          APP_BASE_NAME="${APP_NAME%.app}"
          
          # 创建临时目录
          mkdir -p /tmp/dmg-build-arm64
          cp -R "$APP_NAME" /tmp/dmg-build-arm64/
          
          # 创建 DMG
          hdiutil create -volname "${APP_BASE_NAME}-arm64" \
            -srcfolder /tmp/dmg-build-arm64 \
            -ov -format UDZO \
            "${APP_BASE_NAME}-arm64.dmg"
          
          # 移动到输出目录
          mkdir -p ../../../../../dist
          mv "${APP_BASE_NAME}-arm64.dmg" ../../../../../dist/

      - name: Upload macOS ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nursor-app-macos-arm64
          path: |
            build/macos/Build/Products/Release/*.app
            dist/*.dmg
          retention-days: 30

  build-macos-x86_64:
    name: Build macOS x86_64
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods dependencies
        working-directory: macos
        run: pod install

      - name: Build macOS x86_64
        run: |
          TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          flutter build macos --release \
            --dart-define=FLUTTER_BUILD_NAME=$TAG_NAME \
            --dart-define=FLUTTER_BUILD_NUMBER=$(date +%s)
        env:
          ARCHS: x86_64
          ONLY_ACTIVE_ARCH: NO

      - name: Create DMG for x86_64
        run: |
          cd build/macos/Build/Products/Release
          APP_NAME=$(find . -name "*.app" -type d | head -n 1 | xargs basename)
          APP_BASE_NAME="${APP_NAME%.app}"
          
          # 创建临时目录
          mkdir -p /tmp/dmg-build-x86_64
          cp -R "$APP_NAME" /tmp/dmg-build-x86_64/
          
          # 创建 DMG
          hdiutil create -volname "${APP_BASE_NAME}-x86_64" \
            -srcfolder /tmp/dmg-build-x86_64 \
            -ov -format UDZO \
            "${APP_BASE_NAME}-x86_64.dmg"
          
          # 移动到输出目录
          mkdir -p ../../../../../dist
          mv "${APP_BASE_NAME}-x86_64.dmg" ../../../../../dist/

      - name: Upload macOS x86_64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nursor-app-macos-x86_64
          path: |
            build/macos/Build/Products/Release/*.app
            dist/*.dmg
          retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        shell: pwsh
        run: |
          $tagName = "${{ github.ref }}".Replace("refs/tags/v", "").Replace("refs/tags/", "")
          $buildNumber = [Math]::Floor([decimal](Get-Date -UFormat %s))
          flutter build windows --release `
            --dart-define=FLUTTER_BUILD_NAME=$tagName `
            --dart-define=FLUTTER_BUILD_NUMBER=$buildNumber
        env:
          CMAKE_ARGS: -A x64

      - name: Create Windows ZIP
        shell: pwsh
        run: |
          $tagName = "${{ github.ref }}".Replace("refs/tags/v", "").Replace("refs/tags/", "")
          $appName = "nursor_app"
          $zipName = "$appName-windows-x64-$tagName.zip"
          $releaseDir = "build/windows/x64/runner/Release"
          
          # 检查 Release 目录是否存在
          if (Test-Path $releaseDir) {
            # 创建输出目录
            New-Item -ItemType Directory -Force -Path dist | Out-Null
            
            # 进入 Release 目录并创建 ZIP
            Push-Location $releaseDir
            Compress-Archive -Path * -DestinationPath "../../../../../dist/$zipName" -Force
            Pop-Location
            
            Write-Host "Created ZIP: dist/$zipName"
            if (Test-Path "dist/$zipName") {
              Write-Host "ZIP file size: $((Get-Item "dist/$zipName").Length) bytes"
            } else {
              Write-Host "ERROR: ZIP file was not created"
              exit 1
            }
          } else {
            Write-Host "ERROR: Release directory not found: $releaseDir"
            exit 1
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nursor-app-windows
          path: |
            dist/*.zip
          if-no-files-found: error
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            lsb-release
          
          # Install appindicator library based on Ubuntu version
          # Ubuntu 20.04+ uses ayatana, older versions use legacy appindicator
          UBUNTU_VERSION=$(lsb_release -rs | cut -d. -f1)
          FULL_VERSION=$(lsb_release -rs)
          echo "Detected Ubuntu version: $FULL_VERSION (major: $UBUNTU_VERSION)"
          
          # Try to install the appropriate package based on Ubuntu version
          # For Ubuntu 20.04+, prefer ayatana; for older, prefer legacy
          APPINDICATOR_INSTALLED=false
          
          if [ "$UBUNTU_VERSION" -ge 20 ]; then
            echo "Attempting to install libayatana-appindicator3-dev for Ubuntu $FULL_VERSION"
            if sudo apt-get install -y libayatana-appindicator3-dev; then
              APPINDICATOR_INSTALLED=true
              echo "Successfully installed libayatana-appindicator3-dev"
            else
              echo "Failed to install libayatana-appindicator3-dev, trying libappindicator3-dev"
              # Try legacy version as fallback
              sudo apt-get remove -y libayatana-appindicator3-dev 2>/dev/null || true
              if sudo apt-get install -y libappindicator3-dev; then
                APPINDICATOR_INSTALLED=true
                echo "Successfully installed libappindicator3-dev"
              fi
            fi
          else
            echo "Attempting to install libappindicator3-dev for Ubuntu $FULL_VERSION"
            if sudo apt-get install -y libappindicator3-dev; then
              APPINDICATOR_INSTALLED=true
              echo "Successfully installed libappindicator3-dev"
            else
              echo "Failed to install libappindicator3-dev, trying libayatana-appindicator3-dev"
              # Try ayatana version as fallback
              sudo apt-get remove -y libappindicator3-dev 2>/dev/null || true
              if sudo apt-get install -y libayatana-appindicator3-dev; then
                APPINDICATOR_INSTALLED=true
                echo "Successfully installed libayatana-appindicator3-dev"
              fi
            fi
          fi
          
          if [ "$APPINDICATOR_INSTALLED" = false ]; then
            echo "ERROR: Failed to install any appindicator library"
            echo "This is required for tray_manager plugin"
            exit 1
          fi
          
          echo "Appindicator library installation completed successfully"

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Build Linux
        run: |
          flutter build linux --release \
            --dart-define=FLUTTER_BUILD_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//') \
            --dart-define=FLUTTER_BUILD_NUMBER=$(date +%s)

      - name: Create Linux tarball
        run: |
          TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          APP_NAME="nursor_app"
          TARBALL_NAME="${APP_NAME}-linux-x64-${TAG_NAME}.tar.gz"
          BUNDLE_DIR="build/linux/x64/release/bundle"
          
          # 检查 bundle 目录是否存在
          if [ ! -d "$BUNDLE_DIR" ]; then
            echo "ERROR: Bundle directory not found: $BUNDLE_DIR"
            exit 1
          fi
          
          # 创建输出目录
          mkdir -p dist
          
          # 进入 bundle 目录并创建 tar.gz
          cd "$BUNDLE_DIR"
          tar -czf "../../../../../../dist/${TARBALL_NAME}" *
          cd - > /dev/null
          
          if [ -f "dist/${TARBALL_NAME}" ]; then
            echo "Created tarball: dist/${TARBALL_NAME}"
            ls -lh "dist/${TARBALL_NAME}"
          else
            echo "ERROR: Tarball was not created"
            exit 1
          fi

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nursor-app-linux
          path: |
            dist/*.tar.gz
          if-no-files-found: error
          retention-days: 30

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-macos-arm64, build-macos-x86_64, build-windows, build-linux]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: List downloaded artifacts
        run: |
          echo "Artifact structure:"
          find artifacts -type f -name "*.dmg" -o -name "*.app" -o -name "*.zip" -o -name "*.tar.gz" | head -20

      - name: Prepare release files
        run: |
          # Create a clean directory for release files
          mkdir -p release-files
          TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')
          
          # Copy macOS ARM64 files
          find artifacts/nursor-app-macos-arm64 -name "*.dmg" -exec cp {} release-files/ \;
          find artifacts/nursor-app-macos-arm64 -name "*.app" -type d -exec cp -R {} release-files/ \;
          
          # Copy macOS x86_64 files
          find artifacts/nursor-app-macos-x86_64 -name "*.dmg" -exec cp {} release-files/ \;
          find artifacts/nursor-app-macos-x86_64 -name "*.app" -type d -exec cp -R {} release-files/ \;
          
          # Copy or create Windows ZIP
          if find artifacts/nursor-app-windows -name "*.zip" | head -1 | grep -q .; then
            echo "Found Windows ZIP file"
            find artifacts/nursor-app-windows -name "*.zip" -exec cp {} release-files/ \;
          else
            echo "Windows ZIP not found, creating from folder..."
            # 查找 Windows Release 文件夹
            WIN_RELEASE_DIR=$(find artifacts/nursor-app-windows -type d -path "*/runner/Release" -o -name "Release" | head -1)
            if [ -n "$WIN_RELEASE_DIR" ] && [ -d "$WIN_RELEASE_DIR" ]; then
              cd "$WIN_RELEASE_DIR"
              zip -r "../../../../release-files/nursor_app-windows-x64-${TAG_NAME}.zip" .
              cd - > /dev/null
              echo "Created Windows ZIP from folder"
            else
              echo "ERROR: Windows Release directory not found"
            fi
          fi
          
          # Copy or create Linux tarball
          if find artifacts/nursor-app-linux -name "*.tar.gz" | head -1 | grep -q .; then
            echo "Found Linux tarball"
            find artifacts/nursor-app-linux -name "*.tar.gz" -exec cp {} release-files/ \;
          else
            echo "Linux tarball not found, creating from folder..."
            # 查找 Linux bundle 文件夹
            LINUX_BUNDLE_DIR=$(find artifacts/nursor-app-linux -type d -path "*/bundle" | head -1)
            if [ -n "$LINUX_BUNDLE_DIR" ] && [ -d "$LINUX_BUNDLE_DIR" ]; then
              cd "$LINUX_BUNDLE_DIR"
              tar -czf "../../../../release-files/nursor_app-linux-x64-${TAG_NAME}.tar.gz" .
              cd - > /dev/null
              echo "Created Linux tarball from folder"
            else
              echo "ERROR: Linux bundle directory not found"
            fi
          fi
          
          echo "Release files prepared:"
          ls -lh release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.PACKAGING_REPO_TOKEN }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## Release ${{ steps.tag.outputs.tag_name }}

            ### Downloads
            - **macOS ARM64**: DMG and APP bundle
            - **macOS x86_64**: DMG and APP bundle  
            - **Windows x64**: ZIP archive
            - **Linux x64**: TAR.GZ archive

            Built from tag: ${{ github.ref }}
          files: |
            release-files/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
          generate_release_notes: false

